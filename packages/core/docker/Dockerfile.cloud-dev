FROM node:22-bookworm-slim

# "local" = install from tarball (dev), "npm" = install from registry (prod)
ARG CRAYON_SOURCE=npm

RUN apt-get update && apt-get install -y python3 make g++ git curl openssh-server \
    && mkdir -p /run/sshd \
    && rm -rf /var/lib/apt/lists/*

# Set npm cache to /npm-cache globally so all npm invocations (build + runtime) use it.
# This means users can run `npm install` without extra flags and still hit the cache.
RUN npm config set cache /npm-cache --global

# Install Claude Code CLI early so this layer is cached independently of crayon changes.
# The _setup user is reused later by `crayon install` to register the plugin.
RUN groupadd -f devs && \
    useradd -m -s /bin/bash -g devs _setup && \
    su -s /bin/bash _setup -c "curl -fsSL https://claude.ai/install.sh | bash" && \
    ln -sf /home/_setup/.local/bin/claude /usr/local/bin/claude

# Pre-install app template node_modules at /node_modules so Node.js finds them
# via standard parent-directory resolution from /data/app (no NODE_PATH needed).
# The template package.json has Handlebars placeholders (e.g. {{crayon_version}})
# that must be resolved before npm install can parse it.
#
# Step 1: Get the template package.json into /tmp/cache-build/.
# For local builds, build-dev.sh copies it into the build context.
# For npm builds, download the tarball and extract just the template.
COPY entrypoint.sh template-package.json* /tmp/
RUN mkdir -p /tmp/cache-build && \
    if [ "$CRAYON_SOURCE" = "local" ]; then \
      mv /tmp/template-package.json /tmp/cache-build/package.json; \
    else \
      npm pack runcrayon@dev --pack-destination /tmp && \
      tar -xzf /tmp/runcrayon-*.tgz -C /tmp/cache-build --strip-components=3 package/templates/app/package.json && \
      rm -f /tmp/runcrayon-*.tgz; \
    fi

# Step 2: Install template deps. This layer caches when deps don't change.
RUN cd /tmp/cache-build && \
    sed -i 's/{{crayon_version}}/dev/g' package.json && \
    sed -i 's/{{app_name}}/cache-app/g' package.json && \
    npm install && \
    mv node_modules / && \
    rm -rf /tmp/cache-build

# runcrayon â€” install from local tarball or npm depending on build arg.
# In dev mode, run: npm pack --pack-destination docker/ (from packages/core)
# The wildcard COPY uses a dot file as fallback so it never fails when no .tgz exists.
COPY entrypoint.sh runcrayon-*.tgz /tmp/build/
RUN if [ "$CRAYON_SOURCE" = "local" ] && ls /tmp/build/runcrayon-*.tgz 1>/dev/null 2>&1; then \
      npm install -g /tmp/build/runcrayon-*.tgz && \
      # Stamp a -dev suffix so scaffolding uses the "dev" dist-tag in package.json
      GLOBAL_PKG="$(npm root -g)/runcrayon/package.json" && \
      node -e "const f='$GLOBAL_PKG'; const p=JSON.parse(require('fs').readFileSync(f,'utf8')); p.version+='-dev.local'; require('fs').writeFileSync(f,JSON.stringify(p,null,2)+'\n')"; \
    else \
      npm install -g runcrayon@dev; \
    fi && \
    rm -rf /tmp/build && \
    rm -rf /node_modules/runcrayon && \
    ln -s "$(npm root -g)/runcrayon" /node_modules/runcrayon

# /node_modules found by Node.js via parent-directory resolution from /data/app.
# /npm-cache is pre-populated during build; world-writable so DEV_USER can use it.
RUN chmod -R a+rwx /npm-cache
ENV PATH=/node_modules/.bin:$PATH

# Register crayon plugin with the _setup user created earlier, then bake into /etc/skel.
# useradd -m copies /etc/skel into new home dirs, so runtime users get Claude Code
# + plugin/marketplace registration without the slow setup on every boot.
RUN CRAYON="$(npm prefix -g)/bin/crayon" && \
    su -s /bin/bash _setup -c "$CRAYON install --force" && \
    test -f /home/_setup/.claude/settings.json || { echo "ERROR: crayon plugin not registered"; exit 1; } && \
    cp -a /home/_setup/. /etc/skel/ && \
    rm -f /etc/skel/.claude/.credentials.json && \
    sed -i 's|/home/_setup|__HOMEDIR__|g' /etc/skel/.claude/plugins/known_marketplaces.json /etc/skel/.claude/plugins/installed_plugins.json && \
    CLAUDE_VER=$(basename "$(readlink /etc/skel/.local/bin/claude)") && \
    ln -sf "../share/claude/versions/$CLAUDE_VER" /etc/skel/.local/bin/claude && \
    ln -sf /etc/skel/.local/bin/claude /usr/local/bin/claude && \
    userdel -r _setup 2>/dev/null || true

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 4173 2222
CMD ["/entrypoint.sh"]
