FROM node:22-bookworm-slim

# "local" = install from tarball (dev), "npm" = install from registry (prod)
ARG OPFLOW_SOURCE=npm

RUN apt-get update && apt-get install -y python3 make g++ git curl \
    && rm -rf /var/lib/apt/lists/*

# Claude Code CLI (global so PTY manager can find it via `which claude`)
RUN npm install -g @anthropic-ai/claude-code

# 0pflow â€” install from local tarball or npm depending on build arg.
# In dev mode, run: npm pack --pack-destination docker/ (from packages/core)
# The wildcard COPY uses a dot file as fallback so it never fails when no .tgz exists.
COPY entrypoint.sh 0pflow-*.tgz /tmp/build/
RUN if [ "$OPFLOW_SOURCE" = "local" ] && ls /tmp/build/0pflow-*.tgz 1>/dev/null 2>&1; then \
      npm install -g /tmp/build/0pflow-*.tgz; \
    else \
      npm install -g 0pflow@dev; \
    fi && \
    rm -rf /tmp/build

# Pre-install app template node_modules at /node_modules so Node.js finds them
# via standard parent-directory resolution from /data/app (no NODE_PATH needed).
# The template package.json has Handlebars placeholders (e.g. {{opflow_version}})
# that must be resolved before npm install can parse it.
RUN TEMPLATE_DIR="$(npm root -g)/0pflow/templates/app" && \
    mkdir -p /tmp/cache-build && cp "$TEMPLATE_DIR/package.json" /tmp/cache-build/ && \
    cd /tmp/cache-build && sed -i 's/{{opflow_version}}/dev/g' package.json && \
    sed -i 's/{{app_name}}/cache-app/g' package.json && \
    npm install --cache /npm-cache && \
    mv node_modules / && \
    rm -rf /tmp/cache-build

# /node_modules found by Node.js via parent-directory resolution from /data/app.
# /npm-cache stores tarballs for fast offline installs when user adds packages.
RUN chmod -R a+rwx /npm-cache
ENV PATH=/node_modules/.bin:$PATH

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 4173
CMD ["/entrypoint.sh"]
